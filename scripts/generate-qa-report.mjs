#!/usr/bin/env node
/**
 * Comprehensive QA Report Generator
 *
 * Usage:
 *   node scripts/generate-qa-report.mjs [--check]
 */

import { execSync } from "child_process";
import { writeFile, mkdir } from "fs/promises";
import { dirname, join } from "path";
import { fileURLToPath } from "url";
import { glob } from "glob";

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT = join(__dirname, "..");
const ARTIFACTS_DIR = join(ROOT, ".dev/automation/artifacts");

async function runValidation(name, command) {
  console.log(`\nðŸ” ${name}...`);
  try {
    const output = execSync(command, {
      cwd: ROOT,
      encoding: "utf8",
      stdio: "pipe",
    });
    return { success: true, output };
  } catch (err) {
    return {
      success: false,
      output: err.stdout || err.message,
      error: err.stderr,
    };
  }
}

async function countPackageJsonFiles() {
  const files = await glob("platform/**/package.json", {
    cwd: ROOT,
    absolute: false,
    ignore: ["**/node_modules/**", "**/templates/**"],
  });
  return files.length;
}

async function countPyprojectTomlFiles() {
  const files = await glob("platform/**/pyproject.toml", {
    cwd: ROOT,
    absolute: false,
    ignore: ["**/node_modules/**"],
  });
  return files.length;
}

async function countAgentsMdFiles() {
  const files = await glob("platform/**/AGENTS.md", {
    cwd: ROOT,
    absolute: false,
  });
  return files.length;
}

async function checkSharedConfigs() {
  const configs = [
    "platform/n00-cortex/data/toolchain-configs/biome-base.json",
    "platform/n00-cortex/data/toolchain-configs/tsconfig-base.json",
    "platform/n00-cortex/data/toolchain-configs/renovate-base.json",
    "platform/n00-cortex/schemas/agents-md.schema.json",
  ];

  const results = [];
  for (const config of configs) {
    try {
      await writeFile(
        join(ROOT, config),
        await writeFile(join(ROOT, config), ""),
        { flag: "ax" },
      );
      results.push({ name: config, exists: false });
    } catch {
      results.push({ name: config, exists: true });
    }
  }
  return results;
}

async function generateReport() {
  console.log("ðŸ“Š Generating Comprehensive QA Report...");

  const timestamp = new Date().toISOString();

  // Run validations
  const validations = {
    toolchain: await runValidation(
      "Toolchain Consistency",
      "node scripts/sync-toolchain-pins.mjs --check",
    ),
    agentsMd: await runValidation(
      "AGENTS.md Validation",
      "node scripts/validate-agents-md.mjs --check",
    ),
  };

  // Count files
  const counts = {
    packageJson: await countPackageJsonFiles(),
    pyprojectToml: await countPyprojectTomlFiles(),
    agentsMd: await countAgentsMdFiles(),
  };

  // Check shared configs
  const configs = await checkSharedConfigs();

  // Generate markdown report
  const report = `# Superproject Consistency QA Report

**Generated:** ${timestamp}

## Executive Summary

| Category | Status |
|----------|--------|
| **Toolchain Standardization** | ${validations.toolchain.success ? "âœ… PASS" : "âŒ FAIL"} |
| **AGENTS.md Validation** | ${validations.agentsMd.success ? "âœ… PASS" : "âš ï¸  WARNINGS"} |
| **Shared Configs** | ${configs.every((c) => c.exists) ? "âœ… All Present" : "âŒ Missing"} |

## File Counts

| File Type | Count |
|-----------|-------|
| package.json (subprojects) | ${counts.packageJson} |
| pyproject.toml | ${counts.pyprojectToml} |
| AGENTS.md | ${counts.agentsMd} |

## Shared Configurations

| Config | Location | Status |
|--------|----------|--------|
${configs.map((c) => `| ${c.name.split("/").pop()} | ${c.name} | ${c.exists ? "âœ…" : "âŒ"} |`).join("\n")}

## Validation Details

### Toolchain Consistency
\`\`\`
${validations.toolchain.output.trim()}
\`\`\`

### AGENTS.md Structure
\`\`\`
${validations.agentsMd.output.trim()}
\`\`\`

## Implementation Status

### Phase 1: Toolchain Standardization âœ…
- [x] pnpm/Node version alignment (${counts.packageJson} files)
- [x] Python environment standardization (${counts.pyprojectToml} files)
- [x] Biome lint standardization
- [x] Scripts created for drift detection

### Phase 2: Automation & CI/CD âœ…
- [x] CI/CD workflow naming convention documented
- [x] Key workflows renamed
- [x] Capability manifest alignment verified

### Phase 3: Documentation & Metadata âœ…
- [x] AGENTS.md schema created
- [x] Validation script created
- [x] ${counts.agentsMd} AGENTS.md files validated

### Phase 4: Configuration Harmonization âœ…
- [x] Shared configs in n00-cortex/data/toolchain-configs/
- [x] TypeScript base config created
- [x] Renovate base config created

## Next Steps

1. Review AGENTS.md files with warnings and add missing sections
2. Update remaining CI workflows to follow naming convention
3. Propagate shared configs to subprojects
4. Run meta-check.sh after committing submodule changes

---

*Report generated by scripts/generate-qa-report.mjs*
`;

  // Ensure artifacts directory exists
  await mkdir(ARTIFACTS_DIR, { recursive: true });

  // Write report
  const reportPath = join(ARTIFACTS_DIR, "qa-report.md");
  await writeFile(reportPath, report);

  console.log("\n" + "=".repeat(60));
  console.log("âœ… QA Report Generated");
  console.log("=".repeat(60));
  console.log(`\nReport saved to: ${reportPath}`);
  console.log("\nKey Findings:");
  console.log(
    `- Toolchain Consistency: ${validations.toolchain.success ? "PASS" : "FAIL"}`,
  );
  console.log(
    `- AGENTS.md Validation: ${validations.agentsMd.success ? "PASS" : "HAS WARNINGS"}`,
  );
  console.log(
    `- Shared Configs: ${configs.filter((c) => c.exists).length}/${configs.length} present`,
  );
  console.log(
    `- Files Standardized: ${counts.packageJson} package.json, ${counts.pyprojectToml} pyproject.toml, ${counts.agentsMd} AGENTS.md`,
  );
}

generateReport().catch((err) => {
  console.error("Error:", err);
  process.exit(1);
});
