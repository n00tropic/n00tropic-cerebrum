name: workspace-health

on:
  pull_request:
  push:
    branches:
      - main
permissions:
  contents: read

jobs:
  health:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no submodules by default)
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          submodules: false
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
      - name: Install OS packages (ripgrep)
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep
      - name: Ensure pnpm is available
        shell: bash
        run: |
          set -eux
          if ! command -v pnpm >/dev/null 2>&1; then
            # Try corepack or install pnpm globally as fallback
            if command -v corepack >/dev/null 2>&1; then
              corepack enable
            else
              npm i -g pnpm@10.22.0
            fi
          fi
      - name: Install n00t dependencies
        working-directory: n00t
        run: |
          set -eux
          npx -y pnpm@10.22.0 install --frozen-lockfile
      - name: Scan for npm usage (fail if found)
        run: npx -y pnpm@10.22.0 run tools:scan-npm -- --exclude=templates,examples,stuff,vendor,scripts/setup-pnpm.sh && echo "No npm usage found"
      - name: Run Biome checks for scripts
        run: npx -y pnpm@10.22.0 exec biome check "scripts/**/*.mjs"
      - name: Install trunk CLI
        run: |
          curl -sSf https://trunk.io/install.sh | sh
          export PATH=$HOME/.trunk/bin:$PATH
          trunk --version
      - name: Try to fetch submodules (optional)
        run: |
          set -eux
          git submodule sync --recursive || true
          git submodule update --init --recursive || echo "Submodules failed to update â€” continuing without them"

      - name: Run trunk checks across subrepos (fmt + check)
        run: |
          # Ensure trunk definitions are synced from the workspace base to subrepos
          npx -y pnpm@10.22.0 run trunk:sync-defs || true
          chmod +x .dev/automation/scripts/run-trunk-subrepos.sh
          .dev/automation/scripts/run-trunk-subrepos.sh --fmt || true
      - name: Install Python linters
        run: |
          python -m pip install --upgrade pip
          pip install isort black ruff
      - name: Run Python lint script
        run: npx -y pnpm@10.22.0 run lint:python
      - name: Run Python lint script (auto-fix safe changes)
        run: npx -y pnpm@10.22.0 run lint:python:fix || true
      - name: Validate cortex schemas
        run: npx -y pnpm@10.22.0 run ci:validate:cortex
      - name: Run workspace.gitDoctor capability
        run: ./.dev/automation/scripts/workspace-gitdoctor-capability.sh --sync-submodules --publish-artifact --strict
