name: security-scan-pr

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    # Run daily at 5 AM UTC
    - cron: "0 5 * * *"

permissions:
  contents: read
  security-events: write

jobs:
  osv-scan:
    name: OSV Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OSV Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: |-
            --config=osv-scanner.toml
            --recursive
            ./

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
          comment-summary-in-pr: true

  npm-audit:
    name: npm/pnpm Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10.29.1"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "25.6.0"
          cache: "pnpm"

      - name: Run pnpm audit
        run: |
          pnpm audit --audit-level=high || true
        working-directory: .
