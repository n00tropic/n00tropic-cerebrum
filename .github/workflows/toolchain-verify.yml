name: toolchain-verify

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [main]

jobs:
  toolchain-verify:
    runs-on: ubuntu-latest
    env:
      PNPM_VERIFY_STORE_INTEGRITY: "true"
      PNPM_SKIP_RECURSIVE_CACHE: "1"
      PNPM_ENABLE_PRELPOSTSCRIPTS: "false"
      ALLOW_SUBREPO_PNPM_INSTALL: "1"
    steps:
      - name: Checkout repo (with submodules)
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Node (LTS from .nvmrc)
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.23.0
          run_install: false

      - name: Install dependencies (no scripts)
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Prune pnpm store
        run: pnpm store prune || true

      - name: Verify toolchain pins
        run: node scripts/check-toolchain-pins.mjs --json
