name: penpot-export-smoke

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "n00plicate/packages/token-orchestrator/**"
      - "n00plicate/packages/design-tokens/**"
      - ".github/workflows/penpot-export.yml"

jobs:
  penpot-export:
    runs-on: ubuntu-latest
    env:
      ALLOW_SUBREPO_PNPM_INSTALL: "1"
      PNPM_SKIP_RECURSIVE_CACHE: "1"
      PNPM_ENABLE_PRELPOSTSCRIPTS: "false"
      PNPM_VERIFY_STORE_INTEGRITY: "true"
    steps:
      - name: Checkout repo (with submodules)
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Node (LTS from .nvmrc)
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.23.0
          run_install: false

      - name: Install JS deps (no lifecycle)
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Approve esbuild (non-interactive)
        run: printf ' y\n' | pnpm approve-builds esbuild || true

      - name: Prune pnpm store
        run: pnpm store prune || true

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo test (penpot fixture ingest)
        working-directory: n00plicate/packages/token-orchestrator
        run: cargo test --tests

      - name: Build design tokens (post-ingest)
        run: pnpm --filter @n00plicate/design-tokens run build
