= Typesense search operations
:page-tags: diataxis:howto, domain:platform, audience:operator, stability:beta
:reviewed: 2025-11-19

This playbook explains how to run the OSS-first search stack for the Cerebrum docs site.

== Modes

* **Offline:** Antora + Lunr (already enabled via `antora-playbook.yml`).
* **Local Typesense:** Preferred for development. Launch a container (see below) and run the DocSearch scraper to populate the index.
* **Remote Typesense:** Optional shared cluster. Override `TYPESENSE_HOST`, `TYPESENSE_PROTOCOL`, and `TYPESENSE_PORT` via secrets when using GitHub Actions or ci.

== Prerequisites

. Docker / Podman.
. Node 20+ (DocSearch scraper) and pnpm-installed Antora dependencies.
. `docs/search/docsearch.typesense.env.example` copied to `.env` with a generated API key (for example, `tskey-<uuid>`).

== Local container steps

```bash
cp docs/search/docsearch.typesense.env.example docs/search/.env
# Edit docs/search/.env with API key + collection name if desired
pnpm exec antora-playbook.yml
pnpm dlx http-server build/site -p 8080 & echo $! > docs/search/logs/http.pid
cd docs/search
source .env && docker compose -f typesense-compose.yml up -d
cd -
CONFIG=$(node -e "const fs=require('fs');const c=JSON.parse(fs.readFileSync('docsearch.config.json','utf8'));c.start_urls=['http://host.docker.internal:8080'];process.stdout.write(JSON.stringify(c));")
docker run --rm --network search_default \
 --add-host.docker.internal:host-gateway \
 -e CONFIG="$CONFIG" \
 -e TYPESENSE_API_KEY=$(grep TYPESENSE_API_KEY docs/search/.env | cut -d= -f2-) \
 -e TYPESENSE_HOST=typesense \
 -e TYPESENSE_PORT=8108 \
 -e TYPESENSE_PROTOCOL=http \
 typesense/docsearch-scraper:0.9.0 | tee docs/search/logs/typesense-reindex-$(date +%Y%m%d).log
node docs/search/scripts/save-typesense-summary.mjs docs/search/logs/typesense-reindex-$(date +%Y%m%d).log
kill $(cat docs/search/logs/http.pid) && rm docs/search/logs/http.pid
cd docs/search && docker compose -f typesense-compose.yml down
```

Artifacts go to `build/site/` (Lunr), Typesense collections, the log under `docs/search/logs/`, and a JSON summary (`.log.json`) that downstream dashboards can import.

[TIP]
====
On macOS/WSL, `host.docker.internal` routes containers back to the host HTTP server. On Linux runners you can replace the `--network` flag with `--network host` and keep `start_urls` set to `http://127.0.0.1:8080`.
====

== GitHub Actions integration

`.github/workflows/search-reindex.yml` builds the docs, launches a short-lived Typesense container, runs the Typesense-maintained Docker image for the DocSearch scraper (`typesense/docsearch-scraper:0.9.0`), and tears everything down. Override the endpoint by setting repository secrets (`TYPESENSE_HOST`, etc.).

== Remote clusters & validation log

For hosted Typesense deployments:

1. Store `TYPESENSE_API_KEY`, `TYPESENSE_HOST`, `TYPESENSE_PORT`, `TYPESENSE_PROTOCOL`, and `TYPESENSE_COLLECTION` as repository secrets.
2. Run `search-reindex.yml` manually after updating docs to validate the remote index.
3. Confirm the workflow summary shows successful scraping; investigate logs if the remote cluster rejects connections.
4. Inspect the uploaded log + JSON summary in the workflow artifacts to capture record counts inside dashboards/control panels.

Each run should drop a timestamped log in `docs/search/logs/`. The current validation evidence:

[%autowidth,cols="1,2"]
|===
| Date (UTC) | Evidence
| 2025-11-19 | `docs/search/logs/typesense-reindex-20251119.log` - 37 pages indexed via `typesense/docsearch-scraper:0.9.0` against the local compose stack + published Typesense alias `n00-docs`.
|===

== Troubleshooting

* `docsearch` fails with 401: make sure the API key environment variable matches the Typesense config.
* Missing documents: ensure every asciidoc page includes `:page-tags:` and `:reviewed:` (checked by `scripts/check-attrs.mjs`).
* Remote host unreachable: rerun with the local compose file to sanity-check config, then revisit firewall/VPC rules.

== References

* ADR-005: Adaptive Planning & Typesense.
* `docs/modules/ROOT/pages/planning.adoc`: Initiative overview + local recipe.
