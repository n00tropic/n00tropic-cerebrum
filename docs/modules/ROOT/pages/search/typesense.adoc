= Typesense Search Runbook
:page-tags: diataxis:howto, domain:platform, audience:operator, stability:beta
:reviewed: 2025-11-19

This page summarises the OSS-first Typesense deployment. See `docs/search/README.adoc` for the full playbook.

== Modes

* **Offline** – Antora + Lunr (already enabled via `antora-playbook.yml`).
* **Local Typesense** – Preferred for development; launch a container with the compose file in `docs/search` and run the DocSearch scraper.
* **Remote Typesense** – Optional shared cluster; override `TYPESENSE_HOST`, `TYPESENSE_PROTOCOL`, and `TYPESENSE_PORT` via secrets in CI.

== Prerequisites

. Docker or Podman.
. Node 20+ (DocSearch scraper) plus pnpm-installed Antora dependencies.
. `docs/search/docsearch.typesense.env.example` copied to `.env` with a generated API key.

== Local Container Steps

```bash
cp docs/search/docsearch.typesense.env.example docs/search/.env
pnpm exec antora antora-playbook.yml
pnpm dlx http-server build/site -p 8080 & echo $! > docs/search/logs/http.pid
cd docs/search && source .env && docker compose -f typesense-compose.yml up -d && cd -
CONFIG=$(node -e "const fs=require('fs');const c=JSON.parse(fs.readFileSync('docsearch.config.json','utf8'));c.start_urls=['http://host.docker.internal:8080'];process.stdout.write(JSON.stringify(c));")
docker run --rm --network search_default --add-host host.docker.internal:host-gateway \
  -e CONFIG="$CONFIG" -e TYPESENSE_API_KEY=$(grep TYPESENSE_API_KEY docs/search/.env | cut -d= -f2-) \
  -e TYPESENSE_HOST=typesense -e TYPESENSE_PORT=8108 -e TYPESENSE_PROTOCOL=http \
  typesense/docsearch-scraper:0.9.0 | tee docs/search/logs/typesense-reindex-$(date +%Y%m%d).log
node docs/search/scripts/save-typesense-summary.mjs docs/search/logs/typesense-reindex-$(date +%Y%m%d).log
kill $(cat docs/search/logs/http.pid) && rm docs/search/logs/http.pid
cd docs/search && docker compose -f typesense-compose.yml down
```

[TIP]
====
If your host supports `--network host` (GitHub Actions runners, native Linux), you can skip the `host.docker.internal` override and keep `start_urls` at `http://127.0.0.1:8080`.
====

== GitHub Actions

`.github/workflows/search-reindex.yml` builds the docs, launches a short-lived Typesense container, runs the Typesense-maintained Docker image (`typesense/docsearch-scraper:0.9.0`) with `--network host`, and tears everything down. Configure secrets (`TYPESENSE_*`) to target remote clusters.

== Validation log

[%autowidth,cols="1,2"]
|===
| Date | Notes
| 2025-11-19 | `docs/search/logs/typesense-reindex-20251119.log[.json]` — 37 records indexed via the compose stack; evidence for ADR-005/ADR-006 close-out.
|===

== Troubleshooting

* 401 from DocSearch – verify API key matches the Typesense config.
* Missing documents – ensure each AsciiDoc page declares `:page-tags:` and `:reviewed:`; `scripts/check-attrs.mjs` enforces this.
* Remote host unreachable – rerun with the local compose stack, then revisit firewall/VPC rules.
